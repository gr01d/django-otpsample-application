<!--
django-logbook-application
Copyright (C) 2020 Gian Mapacpac

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
{% extends 'logbook/base.html' %}
{% load bbcode_tags %}
{% bbcode entry.bbcode_content %}
{% block content %}
{% if user.is_authenticated %}
<h2>Notes</h2>
<table id="notetable" class="table table-striped table-bordered">
  <thead class="thead-dark">
    <tr>
      <th>ID</th> <!-- id -->
      <th>Note</th> <!-- note -->
      <th>Created Date</th> <!-- created_date -->
      <th>Actions <a href="{% url 'note_add' %}">(Add)</a></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<h2>Logs</h2>
<table id="logtable" class="table table-striped table-bordered">
  <thead class="thead-dark">
    <tr>
      <th>ID</th> <!-- id -->
      <th>Log</th> <!-- log -->
      <th>Created Date</th> <!-- created_date -->
      <th>Actions <a href="{% url 'log_add' %}">(Add)</a></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

{% endif %}
{% endblock %}


{% block extra_js %}
<!-- DataTables is licensed under MIT
  https://github.com/DataTables/DataTables -->
<script src="/static/js/jquery-3.3.1.js"></script>
<script src="/static/js/popper.min.js"></script>
<!--<script src="/static/js/bootstrap.min.js"></script>-->
<script src="/static/js/jquery.dataTables.min.js"></script>



<script>
  $(document).ready(function() {
    /* Here begins the DataTable configuration. */
    var table = $('#notetable').DataTable({
      //responsive: true,
      stateSave: true,
      stateDuration: -1,
      paginate: true,
      processing: true,
      dom: 'lBfrtip',
      lengthMenu: [
        [10, 25, 50, 100, -1],
        [10, 25, 50, 100, "All"]
      ],
      order: [
        [1, "desc"]
      ],
      /* Tell the DataTable that we need server-side processing. */
      serverSide: true,
      /* Set up the data source */
      ajax: {
        url: "{% url 'note_list_json' %}"
      },
      /* And set up the columns. Note that they must be identified by a "name" attribute,
         with the value matching the columns in your Django view. The "data" attribute selects which record value will be used,
         and should be the same value than for the "name" attribute. */
      columns: [{
          name: "ID",
          data: "id"
        },
        {
          name: "Note",
          data: "notecontent"
        }, //FIXME: Render Bbcode?
        {
          name: "Date",
          data: "created_date"
        },
        {
          name: "Actions",
          data: "id"
        },
      ],
      /* Cannot use responsive mode if columnDefs is enabled */
      /* https://datatables.net/forums/discussion/24298/adding-custom-actions-on-column */
      columnDefs: [{
        targets: 3,
        "data": "id",
        "render": function(data, type, full, meta) {
          return '<a href="{% url 'note_detail' pk=0 %}"> Detail </a>'.replace("0", data) + '<a href="{% url 'note_edit' pk=0 %}"> Edit </a>'.replace("0", data) + '<a href="#" onclick="confirm_delete(pk=0);" %}">Delete </a>'.replace("0",
            data)
        }
      }],


    });

    var table = $('#logtable').DataTable({
      //responsive: true,
      stateSave: true,
      stateDuration: -1,
      paginate: true,
      processing: true,
      dom: 'lBfrtip',
      lengthMenu: [
        [10, 25, 50, 100, -1],
        [10, 25, 50, 100, "All"]
      ],
      order: [
        [1, "desc"]
      ],
      /* Tell the DataTable that we need server-side processing. */
      serverSide: true,
      /* Set up the data source */
      ajax: {
        url: "{% url 'log_list_json' %}"
      },
      /* And set up the columns. Note that they must be identified by a "name" attribute,
         with the value matching the columns in your Django view. The "data" attribute selects which record value will be used,
         and should be the same value than for the "name" attribute. */
      columns: [{
          name: "ID",
          data: "id"
        },
        {
          name: "Log",
          data: "logcontent"
        }, //FIXME: Render Bbcode?
        {
          name: "Date",
          data: "created_date"
        },
        {
          name: "Actions",
          data: "id"
        },
      ],
      /* Cannot use responsive mode if columnDefs is enabled */
      /* https://datatables.net/forums/discussion/24298/adding-custom-actions-on-column */
      columnDefs: [{
        targets: 3,
        "data": "id",
        "render": function(data, type, full, meta) {
          return '<a href="{% url 'log_detail' pk=0 %}"> Detail </a>'.replace("0", data) + '<a href="{% url 'log_edit' pk=0 %}"> Edit </a>'.replace("0", data) + '<a href="#" onclick="confirm_delete_log(pk=0);" %}">Delete </a>'.replace("0",
            data)
        }
      }],


    });


    /* setInterval(function() {
      table.ajax.reload(null, false); // user paging is not reset on reload
    }, 30000); */
  });
</script>
<script type="text/javascript">
  function confirm_delete(pkey) {
    var r = confirm("Confirm deletion of note ID: " + pkey + " ?");
    if (r == true) {
      let url = "{% url 'note_delete' 0 %}".replace("0", pkey);
      window.location.href = url; //Credit: u/DrMaxwellEdison
    }
  }
  function confirm_delete_log(pkey) {
    var r = confirm("Confirm deletion of log ID: " + pkey + " ?");
    if (r == true) {
      let url = "{% url 'log_delete' 0 %}".replace("0", pkey);
      window.location.href = url; //Credit: u/DrMaxwellEdison
    }
  }
</script>

{% endblock %}

{% load static %}
